apiVersion: apps/v1
kind: Deployment
metadata:
 name: {{ include "mychart.fullname" . }}
spec:
 replicas: 1
 selector:
   matchLabels:
     app: {{ include "mychart.name" . }}
 template:
   metadata:
     labels:
       app: {{ include "mychart.name" . }}
   spec:
      containers:
        - name: debian-worker
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          # Comando per installare dipendenze e agire sul file montato
          command: ["/bin/sh"]
          args:
            - "-c"
            - |
              apt-get update && \
              apt-get install -y {{ .Values.packages }} && \
              echo "Eseguo azioni con il file montato..." && \
              wget -c https://github.com/ekristen/aws-nuke/releases/download/{{ include "AWS_NUKE_VERSION" . }}/aws-nuke-{{ include "AWS_NUKE_VERSION" . }}-linux-arm64.tar.gz -O - | tar -xz \
              chmod +x aws-nuke\
              cat /etc/config/extra-config.yaml \
              aws-nuke run --config /etc/config/extra-config.yaml --no-alias-check --no-dry-run --force
          volumeMounts:
            - name: config-volume
              mountPath: /etc/config # Cartella dove apparir√† il file
              readOnly: true
      volumes:
        - name: config-volume
          configMap:
            # Collegamento dinamico al nome della ConfigMap creata sopra
            name: {{ include "mychart.fullname" . }}-external-file
